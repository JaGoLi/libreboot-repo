<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<style type="text/css">
		@import url('../css/main.css');
	</style>

	<title>How to programme an SPI flash chip with the BeagleBone Black</title>
</head>

<body>

	<div class="section">
		<h1 id="pagetop">How to programme an SPI flash chip with the BeagleBone Black</h1>
			<p>This section documents how to use the BBB as an external flashrom programmer, for reading and writing an SPI flash chip.</p>
			<p><a href="index.html">Back to previous index</a></p>
	</div>

	<div class="section">

		<h1 id="hardware_requirements">Hardware requirements</h1>
		
			<p>
				Shopping list (pictures of this hardware is shown later):
			</p>
				<ul>
					<li>
						External SPI programmer: <b>BeagleBone Black</b> (rev. C)
						is highly recommended. Sometimes referred to as 'BBB'.
					</li>
					<li>
						Clip for connecting to the flash chip: if you have a SOIC-16
						flash chip (16 pins), you will need the <b>Pomona 5252</b>
						or equivalent. For SOIC-8 flash chips (8 pins), you will
						need the <b>Pomona 5250</b> or equivalent. Do check which chip you have,
						before ordering a clip. Also, make sure to buy at least two clips
						(they break easily).
					</li>
					<li>
						<b>External 3.3V DC power supply</b>. 
						An ATX power supply / PSU (common on Intel/AMD desktop computers) will work for this.
					</li>
					<li>
						<b>jumper cables</b> (2.54mm / 0.1&quot; headers)
						You should get male-male, male-female and female-female
						cables in 10cm and 20cm sizes. Just get a load of them.
					</li>
					<li>
						<b>Mini USB A-B cable</b> (the BeagleBone probably already comes
						with one.)
					</li>
					<li>
						<b>FTDI serial board</b>, for unbricking the BeagleBone if
						necessary.
					</li>
					<li>
						<b>5V DC power supply</b> (from wall outlet to the BeagleBone).
						The BeagleBone can have power supplied via USB, but a
						dedicated power supply is recommended. 
					</li>
				</ul>
		
			<p>
				<a href="#pagetop">Back to top of page.</a>
			</p>
			
	</div>
		
	<div class="section">

		<h1>Setting up the 3.3V DC PSU</h1>

			<p>
				ATX PSU pinouts are on <a href="https://en.wikipedia.org/wiki/Power_supply_unit_%28computer%29#Wiring_diagrams">wikipedia</a>
			</p>
			<p>
				On 20-pin ATX PSUs, you can use pin 1 or 2 (orange) for 3.3V, and any of the ground/earth sources (black cables).
				Short PS_ON# / Power on (green) to a ground (black. there is one right next to it) using a wire/paperclip/jumper then
				power on the PSU.
			</p>
			<p>
				On newer 24-pin ATX PSUs, there is an additional 3.3V (orange) on pin 12.
			</p>
			<p>
				You only need one 3.3V supply and one ground for the flash chip, after grounding PS_ON# to ground.
				Multiple 3.3V supplies means that you could theoretically power multiple flash chips at once with the
				same PSU.
			</p>
			
			<p>
				Here is an example set up:<br/>
				<img src="images/x200/psu33.jpg" alt="" title="Copyright &copy; 2015 Patrick &quot;P. J.&quot; McDermott &lt;pj@pehjota.net&gt; CC BY-SA 3.0 or later" />
			</p>
			
	</div>
	
	<div class="section">
		
		<h1>Setting up the BBB</h1>
			<p>
				Your BBB will have an sshd with no password on root. Find it's IP address
				(it will use DHCP by default) and set a root password. The steps below
				are done while SSH'd into a BBB.
			</p>
			<p>
				You can also use a serial FTDI debug board, with GNU Screen (example):<br/>
				# <b>screen /dev/ttyUSB0 115200</b><br/>
				<img src="images/x200/ftdi.jpg" alt="" />
				<img src="images/x200/ftdi_port.jpg" alt="" /><br/>
				show an FTDI debug board in use. With screen you can then login as root, like you would using SSH.<br/>
				Using this, you can also see text output (from kernel, etc) when booting the machine.
			</p>
			<p>
				You can also simply connect the USB cable from the BBB to another computer and a new network interface will appear,
				with it's own IP address: this is the BBB. You can SSH into that. Or, you can (example):<br/>
				# <b>screen /dev/ttyACM0 115200</b>
			</p>
			<p>
				These instructions may or may not work for you. They are simply the steps that this author took.
			</p>
			<p>
				setting up SPIDEV on the BBB: <a href="http://elinux.org/BeagleBone_Black_Enable_SPIDEV#SPI0">http://elinux.org/BeagleBone_Black_Enable_SPIDEV#SPI0</a>
				- If you only setup SPI0, you don't have to disable the HDMI out. (you only need one).
				That guide is for seting up the device overlay for SPIDEV, last part is to make it persist across reboots.
				Needed to turn the BBB into an SPI flasher.
			</p>
			<p>
				Don't bother modifying uEnv.txt. it won't work;
				use the workaround here instead: <a href="http://elinux.org/Beagleboard:BeagleBoneBlack_Debian#Loading_custom_capes">http://elinux.org/Beagleboard:BeagleBoneBlack_Debian#Loading_custom_capes</a>.
			</p>
			<p>
				Follow the instructions at <a href="http://elinux.org/BeagleBone_Black_Enable_SPIDEV#SPI0">http://elinux.org/BeagleBone_Black_Enable_SPIDEV#SPI0</a>
				up to (and excluding) the point where it tells you to modify uEnv.txt
			</p>
			<p>
				You need to update the software on the BBB first. If you have an
				element14 brand BBB (sold by Premier Farnell plc. stores like
				Farnell element14, Newark element14, and Embest), you may need
				to <a href="https://groups.google.com/forum/?_escaped_fragment_=msg/beagleboard/LPjCn4LEY2I/alozBGsbTJMJ#!msg/beagleboard/LPjCn4LEY2I/alozBGsbTJMJ">work around a bug</a>
				in the LED aging init script before you can update your
				software. If you don't have a file named
				/etc/init.d/led_aging.sh, you can skip this step and update your
				software as described below. Otherwise, replace the contents of
				this file with:
			</p>
<pre>
#!/bin/sh -e
### BEGIN INIT INFO
# Provides:          led_aging.sh
# Required-Start:    $local_fs
# Required-Stop:     $local_fs
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Short-Description: Start LED aging
# Description:       Starts LED aging (whatever that is)
### END INIT INFO

x=$(/bin/ps -ef | /bin/grep "[l]ed_acc")
if [ ! -n "$x" -a -x /usr/bin/led_acc ]; then
    /usr/bin/led_acc &amp;
fi
</pre>
			</p>
				Run <b>apt-get update</b> and <b>apt-get upgrade</b> then reboot the BBB, before continuing.
			</p>
			<p>
				Run those commands:<br/>
				# <b>echo BB-SPI0-01 &gt; /sys/devices/bone_capemgr.*/slots</b><br/>
				Then I did:<br/>
				# <b>ls -al /dev/spidev0.*</b><br/>
				<i>ls: cannot access /dev/spidev0.*: No such file or directory</i><br/>
				Then I rebooted and did:<br/>
				# <b>cat /sys/devices/bone_capemgr.*/slots</b><br/>
				Output:
			</p>
<pre>
 0: 54:PF--- 
 1: 55:PF--- 
 2: 56:PF--- 
 3: 57:PF--- 
 4: ff:P-O-L Bone-LT-eMMC-2G,00A0,Texas Instrument,BB-BONE-EMMC-2G
 5: ff:P-O-L Bone-Black-HDMI,00A0,Texas Instrument,BB-BONELT-HDMI
</pre>
			<p>
				And then:<br/>
				# <b>ls /lib/firmware/BB-SPI0-01-00A0.*</b><br/>
				Output:
			</p>
<pre>
/lib/firmware/BB-SPI0-01-00A0.dtbo
</pre>
			<p>
				Then:<br/>
				# <b>echo BB-SPI0-01 &gt; /sys/devices/bone_capemgr.*/slots</b><br/>
				# <b>cat /sys/devices/bone_capemgr.*/slots</b><br/>
				Output:
			</p>
<pre>
 0: 54:PF--- 
 1: 55:PF--- 
 2: 56:PF--- 
 3: 57:PF--- 
 4: ff:P-O-L Bone-LT-eMMC-2G,00A0,Texas Instrument,BB-BONE-EMMC-2G
 5: ff:P-O-L Bone-Black-HDMI,00A0,Texas Instrument,BB-BONELT-HDMI
 7: ff:P-O-L Override Board Name,00A0,Override Manuf,BB-SPI0-01
</pre>
			<p>
				Then check if the device exists:<br/>
				# <b>ls -al /dev/spidev0.*</b><br/>
				Output:
			</p>
<pre>
ls: cannot access /dev/spidev0.*: No such file or directory
</pre>
			<p>
				It didn't exist under that name, but I then did:<br/>
				# <b>ls -al /dev/spid*</b><br/>
				Output:
			</p>
<pre>
crw-rw---T 1 root spi 153, 0 Nov 19 21:07 /dev/spidev1.0
</pre>
			<p>
				Now the BBB is ready to be used for flashing. Make this persist
				across reboots:<br/>
				In /etc/default/capemgr add <b>CAPE=BB-SPI0-01</b> at the end
				(or change the existing <b>CAPE=</b> entry to say that, if an
				entry already exists.
			</p>
			<p>
				Get flashrom from libreboot_util release archive, or build it from libreboot_src/git if you need to.
				An ARM binary (statically compiled) for flashrom exists in libreboot_util releases.
			</p>
			
			<p>
				Now test flashrom:<br/>
				# <b>./flashrom -p linux_spi:dev=/dev/spidev1.0,spispeed=512</b><br/>
				Output:
			</p>
<pre>
Calibrating delay loop... OK.
No EEPROM/flash device found.
Note: flashrom can never write if the flash chip isn't found automatically.
</pre>

			<p>
				This means that it's working (the clip isn't connected to any flash chip,
				so the error is fine).
			</p>
			
	</div>
	
	<div class="section">
			
		<h1>
			Connecting the Pomona 5250/5252
		</h1>
			<p>
				Use this image for reference when connecting the pomona to the BBB:
				<a href="http://beagleboard.org/Support/bone101#headers">http://beagleboard.org/Support/bone101#headers</a>
				(D0 = MISO or connects to MISO).
			</p>
		
			<p>
				The following shows how to connect clip to the BBB	(on the P9 header), for SOIC-16 (clip: Pomona 5252):
			</p>
<pre>
 NC              -       - 21
 1               -       - 17
 NC              -       - NC
 NC              -       - NC
 NC              -       - NC
 NC              -       - NC
 18              -       - 3.3V PSU RED
 22              -       - NC - this is pin 1 on the flash chip
<i>This is how you will connect. Numbers refer to pin numbers on the BBB, on the plugs near the DC jack.</i>
</pre>
			<p>
				The following shows how to connect clip to the BBB	(on the P9 header), for SOIC-8 (clip: Pomona 5250):
			</p>
<pre>
 18              -       - 1
 22              -       - NC
 NC              -       - 21
 3.3V PSU RED    -       - 17 - this is pin 1 on the flash chip
<i>This is how you will connect. Numbers refer to pin numbers on the BBB, on the plugs near the DC jack.</i>
</pre>
			<p>
				<b>NC = no connection</b>
			</p>
			<p>
				<b><u>DO NOT</u> connect 3.3V PSU RED yet. ONLY connect this once the pomona is connected to the flash chip.</b>
			</p>
			<p>
				<b>You also need to connect the BLACK wire from the 3.3V PSU to pin 2 on the BBB (P9 header). It is safe to install this now
				(that is, before you connect the pomona to the flash chip).</b>
			</p>
			<p>
				if you need to extend the 3.3v psu leads, just use the same colour M-F leads, <b>but</b> keep all other 
				leads short (10cm or less)
			</p>
			
			<p>
				You should now have something that looks like this:<br/>
				<img src="images/x200/5252_bbb0.jpg" alt="" />
				<img src="images/x200/5252_bbb1.jpg" alt="" />
			</p>
			
		<p>
			That's basically it. Now refer back to the <a href="index.html">installation</a> page for how to use this on your board.
		</p>
			
		<p>
			<a href="#pagetop">Back to top of page.</a>
		</p>
		
	</div>

	<div class="section">

		<p>
			Copyright &copy; 2014, 2015 Francis Rowe &lt;info@gluglug.org.uk&gt;<br/>
			Copyright &copy; 2015 Patrick &quot;P. J.&quot; McDermott &lt;pj@pehjota.net&gt;<br/>
			This document is released under the Creative Commons Attribution-ShareAlike 4.0 International Public License and all future versions.
			A copy of the license can be found at <a href="../license.txt">../license.txt</a>.
		</p>

		<p>
			This document is distributed in the hope that it will be useful,
			but WITHOUT ANY WARRANTY; without even the implied warranty of
			MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See <a href="../license.txt">../license.txt</a> for more information.
		</p>
		
	</div>

</body>
</html>
