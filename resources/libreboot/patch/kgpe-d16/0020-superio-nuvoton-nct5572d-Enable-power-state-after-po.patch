From 5f367eefa624cdc66127e0effafdc08d68352c4e Mon Sep 17 00:00:00 2001
From: Timothy Pearson <kb9vqf@pearsoncomputing.net>
Date: Sat, 5 Sep 2015 18:26:30 -0500
Subject: [PATCH 020/146] superio/nuvoton/nct5572d: Enable power state after
 power failure support

---
 src/superio/nuvoton/nct5572d/superio.c |   31 +++++++++++++++++++++++++++++++
 1 file changed, 31 insertions(+)

diff --git a/src/superio/nuvoton/nct5572d/superio.c b/src/superio/nuvoton/nct5572d/superio.c
index c5278d6..ccf2416 100644
--- a/src/superio/nuvoton/nct5572d/superio.c
+++ b/src/superio/nuvoton/nct5572d/superio.c
@@ -3,6 +3,7 @@
  *
  * Copyright (C) 2014 Felix Held <felix-coreboot@felixheld.de>
  * Copyright (C) 2014 Edward O'Callaghan <eocallaghan@alterapraxis.com>
+ * Copyright (C) 2015 Timothy Pearson <tpearson@raptorengineeringinc.com>, Raptor Engineering
  *
  * This program is free software; you can redistribute it and/or modify
  * it under the terms of the GNU General Public License as published by
@@ -19,17 +20,29 @@
  * Foundation, Inc.
  */
 
+#include <console/console.h>
 #include <arch/io.h>
 #include <device/device.h>
 #include <device/pnp.h>
 #include <pc80/keyboard.h>
+#include <pc80/mc146818rtc.h>
 #include <stdlib.h>
 #include <superio/conf_mode.h>
 
 #include "nct5572d.h"
 
+#define MAINBOARD_POWER_OFF 0
+#define MAINBOARD_POWER_ON 1
+
+#ifndef CONFIG_MAINBOARD_POWER_ON_AFTER_POWER_FAIL
+#define CONFIG_MAINBOARD_POWER_ON_AFTER_POWER_FAIL MAINBOARD_POWER_ON
+#endif
+
 static void nct5572d_init(struct device *dev)
 {
+	uint8_t byte;
+	uint32_t power_status;
+
 	if (!dev->enabled)
 		return;
 
@@ -38,6 +51,24 @@ static void nct5572d_init(struct device *dev)
 	case NCT5572D_KBC:
 		pc_keyboard_init();
 		break;
+	case NCT5572D_ACPI:
+		/* Set power state after power fail */
+		power_status = CONFIG_MAINBOARD_POWER_ON_AFTER_POWER_FAIL;
+		get_option(&power_status, "power_on_after_fail");
+		pnp_enter_conf_mode_8787(dev);
+		outb(0x07, dev->path.pnp.port);
+		outb(NCT5572D_ACPI, dev->path.pnp.port+1);	/* ACPI function */
+		outb(0xe4, dev->path.pnp.port);			/* CRE4 */
+		byte = inb(dev->path.pnp.port+1);
+		byte &= ~0x60;
+		if (power_status == 1)
+			byte |= (0x1 << 5);    /* Force power on */
+		else if (power_status == 2)
+			byte |= (0x2 << 5);    /* Use last power state */
+		outb(byte, dev->path.pnp.port+1);
+		pnp_exit_conf_mode_aa(dev);
+		printk(BIOS_INFO, "set power %s after power fail\n", power_status ? "on" : "off");
+		break;
 	}
 }
 
-- 
1.7.9.5

