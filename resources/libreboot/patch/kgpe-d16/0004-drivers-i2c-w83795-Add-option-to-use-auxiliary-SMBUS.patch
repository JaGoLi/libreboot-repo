From 8996dda2293b74ec84251cc2eefb7722acd6bd6b Mon Sep 17 00:00:00 2001
From: Timothy Pearson <tpearson@raptorengineeringinc.com>
Date: Sat, 17 Oct 2015 04:37:10 -0500
Subject: [PATCH 004/143] drivers/i2c/w83795: Add option to use auxiliary
 SMBUS controller

Change-Id: I5a9b5eba992853b84b0cb6c3a1764edf42ac49b2
Signed-off-by: Timothy Pearson <tpearson@raptorengineeringinc.com>
---
 src/drivers/i2c/w83795/chip.h   |    7 +++++++
 src/drivers/i2c/w83795/w83795.c |   17 +++++++++++++++++
 2 files changed, 24 insertions(+)

diff --git a/src/drivers/i2c/w83795/chip.h b/src/drivers/i2c/w83795/chip.h
index c8a42ea..9a3f847 100644
--- a/src/drivers/i2c/w83795/chip.h
+++ b/src/drivers/i2c/w83795/chip.h
@@ -139,4 +139,11 @@ struct drivers_i2c_w83795_config {
 	uint8_t fan6_duty;			/* % of full speed (0-100) */
 	uint8_t fan7_duty;			/* % of full speed (0-100) */
 	uint8_t fan8_duty;			/* % of full speed (0-100) */
+
+	uint8_t smbus_aux;			/* 0   == device located on primary SMBUS,
+						 * 1   == device located on first auxiliary
+						 *        SMBUS channel,
+						 * <n> == device located on <n> auxiliary
+						 *        SMBUS channel
+						 */
 };
diff --git a/src/drivers/i2c/w83795/w83795.c b/src/drivers/i2c/w83795/w83795.c
index 0af272f..0f82e1c 100644
--- a/src/drivers/i2c/w83795/w83795.c
+++ b/src/drivers/i2c/w83795/w83795.c
@@ -141,7 +141,18 @@ static void w83795_init(struct device *dev, w83795_fan_mode_t mode, u8 dts_src)
 	uint8_t val;
 	uint16_t limit_value;
 
+#if IS_ENABLED(CONFIG_SMBUS_HAS_AUX_CHANNELS)
+	uint8_t smbus_aux_channel_prev = smbus_current_aux_channel();
+	smbus_switch_to_aux_channel(config->smbus_aux);
+	printk(BIOS_DEBUG, "Set SMBUS controller to channel %d\n", config->smbus_aux);
+#endif
+
 	if (smbus_read_byte(dev, 0x00) < 0) {
+#if IS_ENABLED(CONFIG_SMBUS_HAS_AUX_CHANNELS)
+		/* Restore SMBUS channel setting */
+		smbus_switch_to_aux_channel(smbus_aux_channel_prev);
+		printk(BIOS_DEBUG, "Set SMBUS controller to channel %d\n", smbus_aux_channel_prev);
+#endif
 		printk(BIOS_ERR, "W83795G/ADG Nuvoton H/W Monitor not found\n");
 		return;
 	}
@@ -332,6 +343,12 @@ static void w83795_init(struct device *dev, w83795_fan_mode_t mode, u8 dts_src)
 	val = w83795_read(dev, W83795_REG_CONFIG);
 	val |= W83795_REG_CONFIG_START;
 	w83795_write(dev, W83795_REG_CONFIG, val);
+
+#if IS_ENABLED(CONFIG_SMBUS_HAS_AUX_CHANNELS)
+	/* Restore SMBUS channel setting */
+	smbus_switch_to_aux_channel(smbus_aux_channel_prev);
+	printk(BIOS_DEBUG, "Set SMBUS controller to channel %d\n", smbus_aux_channel_prev);
+#endif
 }
 
 static void w83795_hwm_init(struct device *dev)
-- 
1.7.9.5

