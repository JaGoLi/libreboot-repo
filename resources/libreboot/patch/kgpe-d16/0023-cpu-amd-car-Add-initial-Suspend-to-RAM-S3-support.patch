From 9ce37d36d63d39880fb2ff50823d087c93e3d7d3 Mon Sep 17 00:00:00 2001
From: Timothy Pearson <kb9vqf@pearsoncomputing.net>
Date: Sat, 5 Sep 2015 18:46:24 -0500
Subject: [PATCH 023/146] cpu/amd/car: Add initial Suspend to RAM (S3) support

---
 src/cpu/amd/car/post_cache_as_ram.c |   12 ++++++++++++
 1 file changed, 12 insertions(+)

diff --git a/src/cpu/amd/car/post_cache_as_ram.c b/src/cpu/amd/car/post_cache_as_ram.c
index 230d1aa..e265de1 100644
--- a/src/cpu/amd/car/post_cache_as_ram.c
+++ b/src/cpu/amd/car/post_cache_as_ram.c
@@ -1,4 +1,5 @@
 /* Copyright (C) 2015 Timothy Pearson <tpearson@raptorengineeringinc.com>, Raptor Engineering
+ * Copyright (C) 2012 ChromeOS Authors
  * 2005.6 by yhlu
  * 2006.3 yhlu add copy data from CAR to ram
  */
@@ -9,6 +10,7 @@
 #include <cpu/amd/mtrr.h>
 #include <cpu/amd/car.h>
 #include <arch/acpi.h>
+#include <romstage_handoff.h>
 #include "cbmem.h"
 #include "cpu/amd/car/disable_cache_as_ram.c"
 
@@ -103,6 +105,13 @@ void post_cache_as_ram(void)
 {
 	void *resume_backup_memory = NULL;
 
+	struct romstage_handoff *handoff;
+	handoff = romstage_handoff_find_or_add();
+	if (handoff != NULL)
+		handoff->s3_resume = acpi_is_wakeup_s3();
+	else
+		printk(BIOS_DEBUG, "Romstage handoff structure not added!\n");
+
 	int s3resume = acpi_is_wakeup_s3();
 	if (s3resume) {
 		cbmem_recovery(s3resume);
@@ -150,6 +159,9 @@ void cache_as_ram_new_stack (void)
 
 	if (acpi_is_wakeup_s3()) {
 		resume_backup_memory = cbmem_find(CBMEM_ID_RESUME);
+#if PRINTK_IN_CAR
+		printk(BIOS_DEBUG, "Resume backup memory location: %p\n", resume_backup_memory);
+#endif
 	}
 	prepare_ramstage_region(resume_backup_memory);
 
-- 
1.7.9.5

