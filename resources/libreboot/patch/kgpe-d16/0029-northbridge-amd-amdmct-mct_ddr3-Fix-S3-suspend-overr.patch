From 0004a1c007784bd577e2323061cd12460b76b2a8 Mon Sep 17 00:00:00 2001
From: Timothy Pearson <kb9vqf@pearsoncomputing.net>
Date: Sun, 31 May 2015 18:46:40 -0500
Subject: [PATCH 029/146] northbridge/amd/amdmct/mct_ddr3: Fix S3 suspend
 overrunning the stack size limit

---
 src/northbridge/amd/amdmct/mct_ddr3/s3utils.c |   16 +++++++++++++---
 1 file changed, 13 insertions(+), 3 deletions(-)

diff --git a/src/northbridge/amd/amdmct/mct_ddr3/s3utils.c b/src/northbridge/amd/amdmct/mct_ddr3/s3utils.c
index 79576d6..2ea7dc1 100644
--- a/src/northbridge/amd/amdmct/mct_ddr3/s3utils.c
+++ b/src/northbridge/amd/amdmct/mct_ddr3/s3utils.c
@@ -545,10 +545,17 @@ int8_t save_mct_information_to_nvram(void)
 
 	struct spi_flash *flash;
 	ssize_t s3nv_offset;
-	struct amd_s3_persistent_data persistent_data;
+	struct amd_s3_persistent_data *persistent_data;
+
+	/* Allocate temporary data structures */
+	persistent_data = malloc(sizeof(struct amd_s3_persistent_data));
+	if (!persistent_data) {
+		printk(BIOS_DEBUG, "Could not allocate S3 data structure in RAM\n");
+		return -1;
+	}
 
 	/* Obtain MCT configuration data */
-	copy_mct_data_to_save_variable(&persistent_data);
+	copy_mct_data_to_save_variable(persistent_data);
 
 	/* Obtain CBFS file offset */
 	s3nv_offset = get_s3nv_file_offset();
@@ -578,7 +585,10 @@ int8_t save_mct_information_to_nvram(void)
 
 	/* Erase and write data structure */
 	flash->erase(flash, s3nv_offset, CONFIG_S3_DATA_SIZE);
-	flash->write(flash, s3nv_offset, sizeof(struct amd_s3_persistent_data), &persistent_data);
+	flash->write(flash, s3nv_offset, sizeof(struct amd_s3_persistent_data), persistent_data);
+
+	/* Deallocate temporary data structures */
+	free(persistent_data);
 
 	/* Tear down SPI flash access */
 	flash->spi->rw = SPI_WRITE_FLAG;
-- 
1.7.9.5

