From 5ae2feaab88902ab9d5bb95eab1ec396f9c01b9f Mon Sep 17 00:00:00 2001
From: Timothy Pearson <tpearson@raptorengineeringinc.com>
Date: Mon, 1 Jun 2015 23:58:59 -0500
Subject: [PATCH 037/139] cpu/amd/car: Add romstage BSP stack overrun detection

Change-Id: Ia2e8f99be9df388e492a633c49df21ca1c57ba13
Signed-off-by: Timothy Pearson <tpearson@raptorengineeringinc.com>
---
 src/cpu/amd/car/cache_as_ram.inc    | 6 +++++-
 src/cpu/amd/car/post_cache_as_ram.c | 8 ++++++++
 2 files changed, 13 insertions(+), 1 deletion(-)

diff --git a/src/cpu/amd/car/cache_as_ram.inc b/src/cpu/amd/car/cache_as_ram.inc
index 6542906..4ccde3f 100644
--- a/src/cpu/amd/car/cache_as_ram.inc
+++ b/src/cpu/amd/car/cache_as_ram.inc
@@ -24,7 +24,7 @@
 #include <cpu/amd/mtrr.h>
 
 #define CacheSize		CONFIG_DCACHE_RAM_SIZE
-#define CacheBase		(0xd0000 - CacheSize)
+#define CacheBase		CONFIG_DCACHE_RAM_BASE
 #define CacheSizeBSPStack	CONFIG_DCACHE_BSP_STACK_SIZE
 #define CacheSizeBSPSlush	CONFIG_DCACHE_BSP_STACK_SLUSH
 
@@ -473,6 +473,10 @@ fam10_end_part1:
 	movl	$(CacheBase + CacheSize), %eax
 	movl	%eax, %esp
 
+	/* Poison the lower stack boundary */
+	movl	$((CacheBase + CacheSize) - CacheSizeBSPStack), %eax
+	movl	$0xdeadbeef, (%eax)
+
 	post_code(0xa3)
 
 	jmp	CAR_FAM10_ap_out
diff --git a/src/cpu/amd/car/post_cache_as_ram.c b/src/cpu/amd/car/post_cache_as_ram.c
index 257b41a..787bedd 100644
--- a/src/cpu/amd/car/post_cache_as_ram.c
+++ b/src/cpu/amd/car/post_cache_as_ram.c
@@ -110,6 +110,14 @@ void post_cache_as_ram(void)
 	void *resume_backup_memory = NULL;
 	uint32_t family = amd_fam1x_cpu_family();
 
+	/* Verify that the BSP didn't overrun the lower stack
+	 * boundary during romstage execution
+	 */
+	volatile uint32_t *lower_stack_boundary;
+	lower_stack_boundary = (void *)((CONFIG_DCACHE_RAM_BASE + CONFIG_DCACHE_RAM_SIZE) - CONFIG_STACK_SIZE);
+	if ((*lower_stack_boundary) != 0xdeadbeef)
+		printk(BIOS_WARNING, "BSP overran lower stack boundary.  Undefined behaviour may result!\n");
+
 	struct romstage_handoff *handoff;
 	handoff = romstage_handoff_find_or_add();
 	if (handoff != NULL)
-- 
1.9.1

