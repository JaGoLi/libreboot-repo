From 4ea76ba84116e05de90ab0e973d6662b35c98455 Mon Sep 17 00:00:00 2001
From: Leah Rowe <info@minifree.org>
Date: Mon, 24 Oct 2016 20:08:33 +0100
Subject: [PATCH] Revert "drivers/lenovo: Add hybrid graphics driver"

This reverts commit 5919ba42ed0ce5b1b13717514698444232c6036c.
---
 src/drivers/lenovo/Kconfig              |  12 ---
 src/drivers/lenovo/Makefile.inc         |   1 -
 src/drivers/lenovo/hybrid_graphics.c    | 125 --------------------------------
 src/mainboard/lenovo/t400/Kconfig       |   1 -
 src/mainboard/lenovo/t420/cmos.default  |   1 -
 src/mainboard/lenovo/t420/cmos.layout   |   5 +-
 src/mainboard/lenovo/t420s/Kconfig      |   1 -
 src/mainboard/lenovo/t420s/cmos.default |   1 -
 src/mainboard/lenovo/t420s/cmos.layout  |   5 +-
 src/mainboard/lenovo/t520/Kconfig       |   1 -
 src/mainboard/lenovo/t520/cmos.default  |   1 -
 src/mainboard/lenovo/t520/cmos.layout   |   5 +-
 src/mainboard/lenovo/t530/Kconfig       |   1 -
 src/mainboard/lenovo/t530/cmos.default  |   1 -
 src/mainboard/lenovo/t530/cmos.layout   |   6 +-
 src/southbridge/intel/i82801ix/Kconfig  |   1 -
 16 files changed, 4 insertions(+), 164 deletions(-)
 delete mode 100644 src/drivers/lenovo/hybrid_graphics.c

diff --git a/src/drivers/lenovo/Kconfig b/src/drivers/lenovo/Kconfig
index 38b86da..f20f3b2 100644
--- a/src/drivers/lenovo/Kconfig
+++ b/src/drivers/lenovo/Kconfig
@@ -27,15 +27,3 @@ config DIGITIZER_ABSENT
 endchoice
 
 endif
-
-config DRIVERS_LENOVO_HYBRID_GRAPHICS
-	bool
-	default n
-
-config HYBRID_GRAPHICS_GPIO_NUM
-	depends on DRIVERS_LENOVO_HYBRID_GRAPHICS
-	int
-	default 52
-	help
-	  Set a default GPIO that sets the panel LVDS signal routing to
-	  integrated or discrete GPU.
diff --git a/src/drivers/lenovo/Makefile.inc b/src/drivers/lenovo/Makefile.inc
index 66f8594..c50db5b 100644
--- a/src/drivers/lenovo/Makefile.inc
+++ b/src/drivers/lenovo/Makefile.inc
@@ -1,2 +1 @@
 ramstage-$(CONFIG_DRIVERS_LENOVO_WACOM) += wacom.c
-ramstage-$(CONFIG_DRIVERS_LENOVO_HYBRID_GRAPHICS) += hybrid_graphics.c
diff --git a/src/drivers/lenovo/hybrid_graphics.c b/src/drivers/lenovo/hybrid_graphics.c
deleted file mode 100644
index 9b46646..0000000
--- a/src/drivers/lenovo/hybrid_graphics.c
+++ /dev/null
@@ -1,125 +0,0 @@
-/*
- * This file is part of the coreboot project.
- *
- * Copyright (C) 2015-2016 Patrick Rudolph
- * Copyright (C) 2015 Timothy Pearson <tpearson@raptorengineeringinc.com>, Raptor Engineering
- *
- * This program is free software; you can redistribute it and/or modify
- * it under the terms of the GNU General Public License as published by
- * the Free Software Foundation; version 2 of the License.
- *
- * This program is distributed in the hope that it will be useful,
- * but WITHOUT ANY WARRANTY; without even the implied warranty of
- * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- * GNU General Public License for more details.
- */
-
-#include <types.h>
-#include <string.h>
-#include <option.h>
-#include <device/device.h>
-#include <device/pci_def.h>
-#include <device/pci_ops.h>
-#include <device/pci_ids.h>
-#include <device/pci.h>
-#include <console/console.h>
-#include <southbridge/intel/common/gpio.h>
-
-/* Hybrid graphics allows to connect LVDS interface to either iGPU
- * or dGPU depending on GPIO level.
- * Nvidia is calling this functionality "muxed Optimus".
- * Some devices, like T430s, only support "muxless Optimus" where the
- * Intel GPU is always connected to the panel.
- * As it is only linked on lenovo and only executed if the GPU exists
- * we know for sure that the dGPU is there and connected to first PEG slot.
- *
- * Note: Once native gfx init is done for AMD or Nvida graphic
- *       cards, merge this code.
- */
-
-#define HYBRID_GRAPHICS_INTEGRATED 0
-#define HYBRID_GRAPHICS_DISCRETE 1
-
-static void hybrid_graphics_disable_peg(struct device *dev)
-{
-	struct device *peg_dev;
-
-	/* connect LVDS interface to iGPU */
-	set_gpio(CONFIG_HYBRID_GRAPHICS_GPIO_NUM, GPIO_LEVEL_HIGH);
-	printk(BIOS_DEBUG, "Hybrid graphics: Switching panel to integrated GPU.\n");
-	dev->enabled = 0;
-
-	/* Disable PEG10 */
-	peg_dev = dev_find_slot(0, PCI_DEVFN(1, 0));
-	if (peg_dev)
-		peg_dev->enabled = 0;
-
-	printk(BIOS_DEBUG, "Hybrid graphics: Disabled PEG10.\n");
-}
-
-/* Called before VGA enable bits are set and only if dGPU
- * is present. Enable/disable VGA devices here. */
-static void hybrid_graphics_enable_peg(struct device *dev)
-{
-	u8 hybrid_graphics_mode;
-
-	hybrid_graphics_mode = HYBRID_GRAPHICS_INTEGRATED;
-	get_option(&hybrid_graphics_mode, "hybrid_graphics_mode");
-
-	if (hybrid_graphics_mode == HYBRID_GRAPHICS_DISCRETE) {
-		/* connect LVDS interface to dGPU */
-		set_gpio(CONFIG_HYBRID_GRAPHICS_GPIO_NUM, GPIO_LEVEL_LOW);
-		printk(BIOS_DEBUG, "Hybrid graphics: Switching panel to discrete GPU.\n");
-		dev->enabled = 1;
-
-		/* Disable IGD */
-		dev = dev_find_slot(0, PCI_DEVFN(2, 0));
-		if (dev && dev->ops->disable)
-			dev->ops->disable(dev);
-		dev->enabled = 0;
-
-		printk(BIOS_DEBUG, "Hybrid graphics: Disabled IGD.\n");
-	} else
-		hybrid_graphics_disable_peg(dev);
-}
-
-static struct pci_operations pci_dev_ops_pci = {
-	.set_subsystem = pci_dev_set_subsystem,
-};
-
-struct device_operations hybrid_graphics_ops = {
-	.read_resources   = pci_dev_read_resources,
-	.set_resources    = pci_dev_set_resources,
-	.enable_resources = pci_dev_enable_resources,
-	.init             = pci_dev_init,
-	.scan_bus         = 0,
-	.enable           = hybrid_graphics_enable_peg,
-	.disable          = hybrid_graphics_disable_peg,
-	.ops_pci          = &pci_dev_ops_pci,
-};
-
-static const unsigned short pci_device_ids_nvidia[] = {
-		0x0ffc, /* Nvidia NVS Quadro K1000m Lenovo W530 */
-		0x0def, /* NVidia NVS 5400m Lenovo T430/T530 */
-		0x0dfc, /* NVidia NVS 5200m Lenovo T430s */
-		0x1056, /* NVidia NVS 4200m Lenovo T420/T520 */
-		0x1057, /* NVidia NVS 4200m Lenovo T420/T520 */
-		0x0a6c, /* NVidia NVS 3100m Lenovo T410/T510 */
-		0 };
-
-static const struct pci_driver hybrid_peg_nvidia __pci_driver = {
-	.ops	 = &hybrid_graphics_ops,
-	.vendor	 = PCI_VENDOR_ID_NVIDIA,
-	.devices = pci_device_ids_nvidia,
-};
-
-static const unsigned short pci_device_ids_amd[] = {
-		0x9591, /* ATI Mobility Radeon HD 3650 Lenovo T500/W500 */
-		0x95c4, /* ATI Mobility Radeon HD 3470 Lenovo T400/R400 */
-		0 };
-
-static const struct pci_driver hybrid_peg_amd __pci_driver = {
-	.ops	 = &hybrid_graphics_ops,
-	.vendor	 = PCI_VENDOR_ID_ATI,
-	.devices = pci_device_ids_amd,
-};
diff --git a/src/mainboard/lenovo/t400/Kconfig b/src/mainboard/lenovo/t400/Kconfig
index a444bf8..d74a813 100644
--- a/src/mainboard/lenovo/t400/Kconfig
+++ b/src/mainboard/lenovo/t400/Kconfig
@@ -22,7 +22,6 @@ config BOARD_SPECIFIC_OPTIONS # dummy
 	select MAINBOARD_HAS_NATIVE_VGA_INIT_TEXTMODECFG
 	select INTEL_INT15
 	select SUPERIO_NSC_PC87382
-	select DRIVERS_LENOVO_HYBRID_GRAPHICS
 
 config MAINBOARD_DIR
 	string
diff --git a/src/mainboard/lenovo/t420/cmos.default b/src/mainboard/lenovo/t420/cmos.default
index cfb7552..1b8e212 100644
--- a/src/mainboard/lenovo/t420/cmos.default
+++ b/src/mainboard/lenovo/t420/cmos.default
@@ -14,4 +14,3 @@ fn_ctrl_swap=Disable
 sticky_fn=Disable
 trackpoint=Enable
 hyper_threading=Enable
-hybrid_graphics_mode=Integrated Only
diff --git a/src/mainboard/lenovo/t420/cmos.layout b/src/mainboard/lenovo/t420/cmos.layout
index 79a3a68..61676a3 100644
--- a/src/mainboard/lenovo/t420/cmos.layout
+++ b/src/mainboard/lenovo/t420/cmos.layout
@@ -77,8 +77,7 @@ entries
 
 # coreboot config options: northbridge
 432          3       e       11       gfx_uma_size
-435          2        e       12       hybrid_graphics_mode
-#437         3        r       0        unused
+#435          5       r       0        unused
 
 440          8       h       0        volume
 
@@ -136,8 +135,6 @@ enumerations
 11    4     160M
 11    5     192M
 11    6     224M
-12    0     Integrated Only
-12    1     Discrete Only
 
 # -----------------------------------------------------------------
 checksums
diff --git a/src/mainboard/lenovo/t420s/Kconfig b/src/mainboard/lenovo/t420s/Kconfig
index feacb51..935e659 100644
--- a/src/mainboard/lenovo/t420s/Kconfig
+++ b/src/mainboard/lenovo/t420s/Kconfig
@@ -18,7 +18,6 @@ config BOARD_SPECIFIC_OPTIONS # dummy
 	select INTEL_INT15
 	select SANDYBRIDGE_IVYBRIDGE_LVDS
 	select MAINBOARD_HAS_LPC_TPM
-	select DRIVERS_LENOVO_HYBRID_GRAPHICS
 
 	# Workaround for EC/KBC IRQ1.
 	select SERIRQ_CONTINUOUS_MODE
diff --git a/src/mainboard/lenovo/t420s/cmos.default b/src/mainboard/lenovo/t420s/cmos.default
index cfb7552..1b8e212 100644
--- a/src/mainboard/lenovo/t420s/cmos.default
+++ b/src/mainboard/lenovo/t420s/cmos.default
@@ -14,4 +14,3 @@ fn_ctrl_swap=Disable
 sticky_fn=Disable
 trackpoint=Enable
 hyper_threading=Enable
-hybrid_graphics_mode=Integrated Only
diff --git a/src/mainboard/lenovo/t420s/cmos.layout b/src/mainboard/lenovo/t420s/cmos.layout
index ec9be11..edbf075 100644
--- a/src/mainboard/lenovo/t420s/cmos.layout
+++ b/src/mainboard/lenovo/t420s/cmos.layout
@@ -77,8 +77,7 @@ entries
 
 # coreboot config options: northbridge
 432          3       e       11       gfx_uma_size
-435          2       e       12       hybrid_graphics_mode
-#437         3       r       0        unused
+#435         5       r       0        unused
 
 440          8       h       0        volume
 
@@ -136,8 +135,6 @@ enumerations
 11    4     160M
 11    5     192M
 11    6     224M
-12    0     Integrated Only
-12    1     Discrete Only
 
 # -----------------------------------------------------------------
 checksums
diff --git a/src/mainboard/lenovo/t520/Kconfig b/src/mainboard/lenovo/t520/Kconfig
index ee5dd81..c70581a 100644
--- a/src/mainboard/lenovo/t520/Kconfig
+++ b/src/mainboard/lenovo/t520/Kconfig
@@ -18,7 +18,6 @@ config BOARD_SPECIFIC_OPTIONS # dummy
 	select INTEL_INT15
 	select SANDYBRIDGE_IVYBRIDGE_LVDS
 	select MAINBOARD_HAS_LPC_TPM
-	select DRIVERS_LENOVO_HYBRID_GRAPHICS
 
 	# Workaround for EC/KBC IRQ1.
 	select SERIRQ_CONTINUOUS_MODE
diff --git a/src/mainboard/lenovo/t520/cmos.default b/src/mainboard/lenovo/t520/cmos.default
index 526a6d6..00e8863 100644
--- a/src/mainboard/lenovo/t520/cmos.default
+++ b/src/mainboard/lenovo/t520/cmos.default
@@ -15,4 +15,3 @@ sticky_fn=Disable
 trackpoint=Enable
 hyper_threading=Enable
 backlight=Both
-hybrid_graphics_mode=Integrated Only
diff --git a/src/mainboard/lenovo/t520/cmos.layout b/src/mainboard/lenovo/t520/cmos.layout
index a151b7e..7e77012 100644
--- a/src/mainboard/lenovo/t520/cmos.layout
+++ b/src/mainboard/lenovo/t520/cmos.layout
@@ -77,8 +77,7 @@ entries
 
 # coreboot config options: northbridge
 432         3        e      11        gfx_uma_size
-435         2        e       12       hybrid_graphics_mode
-#437        3        r       0        unused
+#435        5        r       0        unused
 440         8        h       0        volume
 
 # SandyBridge MRC Scrambler Seed values
@@ -135,8 +134,6 @@ enumerations
 11    4	    160M
 11    5	    192M
 11    6	    224M
-12    0     Integrated Only
-12    1     Discrete Only
 # -----------------------------------------------------------------
 checksums
 
diff --git a/src/mainboard/lenovo/t530/Kconfig b/src/mainboard/lenovo/t530/Kconfig
index 76147fc..030c01f 100644
--- a/src/mainboard/lenovo/t530/Kconfig
+++ b/src/mainboard/lenovo/t530/Kconfig
@@ -21,7 +21,6 @@ config BOARD_SPECIFIC_OPTIONS # dummy
 	select SANDYBRIDGE_IVYBRIDGE_LVDS
 	select ENABLE_VMX
 	select MAINBOARD_HAS_LPC_TPM
-	select DRIVERS_LENOVO_HYBRID_GRAPHICS
 
 	# Workaround for EC/KBC IRQ1.
 	select SERIRQ_CONTINUOUS_MODE
diff --git a/src/mainboard/lenovo/t530/cmos.default b/src/mainboard/lenovo/t530/cmos.default
index 526a6d6..00e8863 100644
--- a/src/mainboard/lenovo/t530/cmos.default
+++ b/src/mainboard/lenovo/t530/cmos.default
@@ -15,4 +15,3 @@ sticky_fn=Disable
 trackpoint=Enable
 hyper_threading=Enable
 backlight=Both
-hybrid_graphics_mode=Integrated Only
diff --git a/src/mainboard/lenovo/t530/cmos.layout b/src/mainboard/lenovo/t530/cmos.layout
index d6d671c..8943813 100644
--- a/src/mainboard/lenovo/t530/cmos.layout
+++ b/src/mainboard/lenovo/t530/cmos.layout
@@ -77,8 +77,7 @@ entries
 
 # coreboot config options: northbridge
 432         3        e      11        gfx_uma_size
-435         2        e       12       hybrid_graphics_mode
-#437        3        r       0        unused
+#435        5        r       0        unused
 
 440          8       h       0        volume
 
@@ -136,9 +135,6 @@ enumerations
 11    4	    160M
 11    5	    192M
 11    6	    224M
-12    0     Integrated Only
-12    1     Discrete Only
-
 # -----------------------------------------------------------------
 checksums
 
diff --git a/src/southbridge/intel/i82801ix/Kconfig b/src/southbridge/intel/i82801ix/Kconfig
index b3e5069..2822774 100644
--- a/src/southbridge/intel/i82801ix/Kconfig
+++ b/src/southbridge/intel/i82801ix/Kconfig
@@ -23,7 +23,6 @@ config SOUTHBRIDGE_INTEL_I82801IX
 	select USE_WATCHDOG_ON_BOOT
 	select HAVE_SMI_HANDLER
 	select HAVE_USBDEBUG_OPTIONS
-	select SOUTHBRIDGE_INTEL_COMMON_GPIO
 
 if SOUTHBRIDGE_INTEL_I82801IX
 
-- 
2.9.3

