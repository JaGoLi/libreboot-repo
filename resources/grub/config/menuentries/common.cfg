menuentry 'Load Operating System' {
	insmod regexp
	insmod ahci
	insmod part_msdos
	insmod part_gpt
	for x in (ahci0,*); do
		if [ -f "$x/grub/libreboot_grub.cfg" ] ; then
			set root=$x
			configfile /grub/libreboot_grub.cfg
		fi
		if [ -f "$x/boot/grub/libreboot_grub.cfg" ] ; then
			set root=$x
			configfile /boot/grub/libreboot_grub.cfg
		fi
	done

	set root='ahci0,1'
	linux  /vmlinuz root=/dev/sda1 rw
	if [ -f "/initrd.img" ] ; then
		initrd /initrd.img
	fi
}
menuentry 'Parse ISOLINUX menu (USB)' {
	for x in (usb0) (usb0,*); do
		set root=$x
		if [ -f "/menu.cfg" ] ; then
			syslinux_configfile -i /menu.cfg
		elif [ -f "/txt.cfg" ] ; then
			syslinux_configfile -i /txt.cfg
		elif [ -f "/isolinux/menu.cfg" ] ; then
			syslinux_configfile -i /isolinux/menu.cfg
		elif [ -f "/isolinux/txt.cfg" ] ; then
			syslinux_configfile -i /isolinux/txt.cfg
		elif [ -f "/isolinux/isolinux.cfg" ] ; then
			syslinux_configfile -i /isolinux/isolinux.cfg
		fi
	done
}
menuentry 'Parse ISOLINUX menu (CD)' {
	for x in (ata0) (ahci1); do
		set root=$x
		if [ -f "/menu.cfg" ] ; then
			syslinux_configfile -i /menu.cfg
		elif [ -f "/txt.cfg" ] ; then
			syslinux_configfile -i /txt.cfg
		elif [ -f "/isolinux/menu.cfg" ] ; then
			syslinux_configfile -i /isolinux/menu.cfg
		elif [ -f "/isolinux/txt.cfg" ] ; then
			syslinux_configfile -i /isolinux/txt.cfg
		elif [ -f "/isolinux/isolinux.cfg" ] ; then
			syslinux_configfile -i /isolinux/isolinux.cfg
		fi
	done
}
menuentry 'Switch to grubtest.cfg' {
	set root='cbfsdisk'
	configfile (cbfsdisk)/grubtest.cfg
}
menuentry 'Search for GRUB configuration on internal storage' {
	insmod regexp
	insmod ahci
	insmod part_msdos
	insmod part_gpt
	for x in (ahci0,*) ; do
		if [ -f "$x/grub/grub.cfg" ] ; then
			submenu "Load Config from $x" $x { 
				root=$2
				source /grub/grub.cfg
				unset superusers
			}
		fi
		if [ -f "$x/boot/grub/grub.cfg" ] ; then
			submenu "Load Config from $x" $x {
				root=$2
				source /boot/grub/grub.cfg
				unset superusers
			}
		fi
	done
}

